from shapely import geometry as shgeo
from deepdiff import DeepDiff

from lib.stitches import auto_fill


def test_auto_fill_box():
    # A box with side length 10 and lower-left corner at (10, 10)
    shape = shgeo.box(10, 10, 20, 20, ccw=True)

    actual = auto_fill(
        shape=shape,
        angle=0,
        row_spacing=1,
        end_row_spacing=1,
        max_stitch_length=1,
        running_stitch_length=1,
        running_stitch_tolerance=1,
        staggers=4,
        skip_last=False,
        starting_point=(10, 10),
        ending_point=(10, 10),
        underpath=False,
    )

    # The start and ending points should be the same
    assert actual[0].isclose(actual[-1])

    # The exact stitches output by the algorithm now
    expected = [
        (10.0, 10.0),
        (11.0, 10.0),
        (12.0, 10.0),
        (13.0, 10.0),
        (14.0, 10.0),
        (15.0, 10.0),
        (16.0, 10.0),
        (17.0, 10.0),
        (18.0, 10.0),
        (19.0, 10.0),
        (20.0, 10.0),
        (20.0, 11.0),
        (20.0, 12.0),
        (20.0, 13.0),
        (20.0, 14.0),
        (20.0, 15.0),
        (20.0, 16.0),
        (20.0, 17.0),
        (20.0, 18.0),
        (20.0, 19.0),
        (20.0, 20.0),
        (19.0, 20.0),
        (18.0, 20.0),
        (17.0, 20.0),
        (16.0, 20.0),
        (15.0, 20.0),
        (14.0, 20.0),
        (13.0, 20.0),
        (12.0, 20.0),
        (11.0, 20.0),
        (10.0, 20.0),
        (10.0, 19.0),
        (10.75, 19.0),
        (11.75, 19.0),
        (12.75, 19.0),
        (13.75, 19.0),
        (14.75, 19.0),
        (15.75, 19.0),
        (16.75, 19.0),
        (17.75, 19.0),
        (18.75, 19.0),
        (19.75, 19.0),
        (20.0, 18.0),
        (19.5, 18.0),
        (18.5, 18.0),
        (17.5, 18.0),
        (16.5, 18.0),
        (15.5, 18.0),
        (14.5, 18.0),
        (13.5, 18.0),
        (12.5, 18.0),
        (11.5, 18.0),
        (10.5, 18.0),
        (10.0, 18.0),
        (10.0, 17.0),
        (10.25, 17.0),
        (11.25, 17.0),
        (12.25, 17.0),
        (13.25, 17.0),
        (14.25, 17.0),
        (15.25, 17.0),
        (16.25, 17.0),
        (17.25, 17.0),
        (18.25, 17.0),
        (19.25, 17.0),
        (20.0, 17.0),
        (20.0, 16.5),
        (20.0, 16.0),
        (19.0, 16.0),
        (18.0, 16.0),
        (17.0, 16.0),
        (16.0, 16.0),
        (15.0, 16.0),
        (14.0, 16.0),
        (13.0, 16.0),
        (12.0, 16.0),
        (11.0, 16.0),
        (10.0, 16.0),
        (10.0, 15.5),
        (10.0, 15.0),
        (10.75, 15.0),
        (11.75, 15.0),
        (12.75, 15.0),
        (13.75, 15.0),
        (14.75, 15.0),
        (15.75, 15.0),
        (16.75, 15.0),
        (17.75, 15.0),
        (18.75, 15.0),
        (19.75, 15.0),
        (20.0, 14.0),
        (19.5, 14.0),
        (18.5, 14.0),
        (17.5, 14.0),
        (16.5, 14.0),
        (15.5, 14.0),
        (14.5, 14.0),
        (13.5, 14.0),
        (12.5, 14.0),
        (11.5, 14.0),
        (10.5, 14.0),
        (10.0, 14.0),
        (10.0, 13.5),
        (10.0, 13.0),
        (10.25, 13.0),
        (11.25, 13.0),
        (12.25, 13.0),
        (13.25, 13.0),
        (14.25, 13.0),
        (15.25, 13.0),
        (16.25, 13.0),
        (17.25, 13.0),
        (18.25, 13.0),
        (19.25, 13.0),
        (20.0, 13.0),
        (20.0, 12.0),
        (19.0, 12.0),
        (18.0, 12.0),
        (17.0, 12.0),
        (16.0, 12.0),
        (15.0, 12.0),
        (14.0, 12.0),
        (13.0, 12.0),
        (12.0, 12.0),
        (11.0, 12.0),
        (10.0, 12.0),
        (10.0, 11.5),
        (10.0, 11.0),
        (10.75, 11.0),
        (11.75, 11.0),
        (12.75, 11.0),
        (13.75, 11.0),
        (14.75, 11.0),
        (15.75, 11.0),
        (16.75, 11.0),
        (17.75, 11.0),
        (18.75, 11.0),
        (19.75, 11.0),
        (20.0, 10.0),
        (19.0, 10.0),
        (18.0, 10.0),
        (17.0, 10.0),
        (16.0, 10.0),
        (15.0, 10.0),
        (14.0, 10.0),
        (13.0, 10.0),
        (12.0, 10.0),
        (11.0, 10.0),
        (10.0, 10.0),
    ]

    actual = [(stitch.x, stitch.y) for stitch in actual]
    assert not DeepDiff(expected, actual, significant_digits=5)


def test_auto_fill_underpath_travels_inside():
    # A box with side length 10 and lower-left corner at (10, 10)
    shape = shgeo.box(10, 10, 20, 20, ccw=True)

    actual = auto_fill(
        shape=shape,
        angle=0,
        row_spacing=1,
        end_row_spacing=1,
        max_stitch_length=1,
        running_stitch_length=1,
        running_stitch_tolerance=1,
        staggers=4,
        skip_last=False,
        starting_point=(10, 10),
        ending_point=(10, 10),
        underpath=True,
    )

    # The start and ending points should be the same.
    assert actual[0].isclose(actual[-1])

    # The initial travel stitch is a straight-lint path through the interior to
    # the opposite corner.
    expected_starting_stitches = [
        (10.0, 10.0),
        (10 + 2 / 3, 10 + 2 / 3),
        (11 + 1 / 3, 11 + 1 / 3),
        (12.0, 12.0),
        (12 + 2 / 3, 12 + 2 / 3),
        (13 + 1 / 3, 13 + 1 / 3),
        (14.0, 14.0),
        (14 + 2 / 3, 14 + 2 / 3),
        (15 + 1 / 3, 15 + 1 / 3),
        (16.0, 16.0),
        (16 + 2 / 3, 16 + 2 / 3),
        (17 + 1 / 3, 17 + 1 / 3),
        (18.0, 18.0),
        (18 + 2 / 3, 18 + 2 / 3),
        (19 + 1 / 3, 19 + 1 / 3),
        (20.0, 20.0),
    ]
    actual_starting_stitches = [
        (stitch.x, stitch.y) for stitch in actual[: len(expected_starting_stitches)]
    ]

    assert not DeepDiff(
        expected_starting_stitches,
        actual_starting_stitches,
        significant_digits=5,
    )
